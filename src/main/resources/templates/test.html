<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- Bootstrap5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <title>Document</title>
</head>
<body>
<div class="col justify-content-center my-1 mx-0">
    <form action="parentCategoryList.html" th:action th:object="${parentCategoryList}" method="post">
        <th:block th:each="list, s : ${parentCategoryList.testLists}">
        <!-- 입력 영역 -->
        <div class="row g-9 ms-3 mt-3 me-5" id="list-a">

            <div th:text="${s}"></div>
            <div th:text="${s.index}"></div>
            <div class="input-group mb-3" th:id="'parent'+${s.count}">
                <input type="text" class="form-control" placeholder="Recipient\'s username"
                       th:field="|${parentCategoryList.testLists[__${s.index}__].parentCategory}|"
                       th:id="'category'+${s.count}" readonly>
                <button class="btn btn-outline-secondary" type="button" th:id="'modify'+${s.count}" th:onclick="|modifyParentCategory(${s.count})|">수정</button>
                <button class="btn btn-outline-secondary" type="button" th:id="'add'+${s.count}" th:onclick="|addParentCategory(${s.count}, ${s.current.childCategories.size()})|">추가</button>
                <button class="btn btn-outline-secondary" type="button" th:id="'delete'+${s.count}" th:onclick="|deleteParentCategory(${s.count})|">삭제</button>
            </div>
            <div class="input-group mb-3 ms-5" th:each="childCategories, ss : ${list.childCategories}" th:id="'child'+${s.count}+${ss.count}">
                <input type="text" class="form-control" style="width: 80%"
                       th:field="|${parentCategoryList.testLists[__${s.index}__].childCategories[__${ss.index}__]}|"
                       th:id="'category'+${s.count}+${ss.count}" readonly>
                <button style="width: 10%" class="btn btn-outline-secondary" type="button" th:id="'modify'+${s.count}+${ss.count}" th:onclick="|modifyParentCategory(${s.count}${ss.count})|">수정</button>
                <button style="width: 10%" class="btn btn-outline-secondary" type="button" th:id="'delete'+${s.count}+${ss.count}" th:onclick="|deleteCategory(${s.count},${ss.count})|">삭제</button>
            </div>

        </div>
        </th:block>
        <button class="w-100 btn btn-primary btn-lg" type="submit">저장</button>
    </form>
</div>
<!-- JQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script th:inline="javascript">
    let count = 0;
    function deleteParentCategory(num) {
        let element = document.getElementById('category'+num);
        let node = element.parentNode.parentNode;

        while (node.hasChildNodes()) {
            node.removeChild(
                node.firstChild
            );
        }
    };

    function deleteCategory(parent, child) {
        document.getElementById('child'+parent+child).remove();
    };

    function addParentCategory(num, size) {
        count++;
        let num2 = count + size;
        let element = document.getElementById('add'+num);
        let lastElementChild = element.parentNode.parentNode.lastElementChild.cloneNode(true);

        console.log(element.parentNode.parentNode.lastElementChild.id);

        if (element.parentNode.parentNode.lastElementChild.id === 'parent1') {
            let a = '';
            a += '            <div class="input-group mb-3 ms-5" id="child' + num + '1">\n' +
                '                <input type="text" class="form-control" style="width: 80%"\n' +
                '                       id="category' + num + '1" name="testLists[' + (num - 1) + '].childCategories[' + (num2 - 1) + ']">\n' +
                '                <button style="width: 10%" class="btn btn-outline-secondary" type="button" id="modify' + num + '1" onclick="modifyParentCategory(' + num + '1)">확인</button>\n' +
                '                <button style="width: 10%" class="btn btn-outline-secondary" type="button" id="deleteCategory(' + num + '1)" onclick="deleteCategory(' + num + ',1)">삭제</button>\n' +
                '            </div>';
            let parentNode = element.parentNode.parentNode;
            $(parentNode).append(a);
        } else {
            console.log('else = ' + count);
            console.log('num2 = ' + num2);

            lastElementChild.setAttribute('id', 'child' + num + num2);

            let htmlInputElement = document.createElement('input');
            htmlInputElement.setAttribute('class', 'form-control');
            htmlInputElement.setAttribute('style', 'width: 80%');
            htmlInputElement.setAttribute('id', 'category' + num + num2);
            htmlInputElement.setAttribute('name', 'testLists[' + (num - 1) + '].childCategories[' + (num2 - 1) + ']');
            htmlInputElement.readOnly = false;

            let htmlButtonElement = document.createElement('button');
            htmlButtonElement.setAttribute('style', 'width: 10%');
            htmlButtonElement.setAttribute('class', 'btn btn-outline-secondary');
            htmlButtonElement.setAttribute('id', 'modify' + num + num2);
            htmlButtonElement.setAttribute('type', 'button');
            htmlButtonElement.setAttribute('onclick', 'modifyParentCategory(' + num + num2 + ')');
            htmlButtonElement.innerHTML = '확인';

            let deleteElement = document.createElement('button');
            deleteElement.setAttribute('style', 'width: 10%');
            deleteElement.setAttribute('class', 'btn btn-outline-secondary');
            deleteElement.setAttribute('id', 'delete' + num + num2);
            deleteElement.setAttribute('type', 'button');
            deleteElement.setAttribute('onclick', 'deleteCategory(' + num + ',' + num2 + ')');
            deleteElement.innerHTML = '삭제';



            lastElementChild.replaceChild(htmlInputElement, lastElementChild.childNodes[1]);
            lastElementChild.replaceChild(htmlButtonElement, lastElementChild.childNodes[3]);
            lastElementChild.replaceChild(deleteElement, lastElementChild.childNodes[5]);
            console.log(lastElementChild.childNodes);
            console.log(lastElementChild);

            console.log(parentCategoryList);
            element.parentNode.parentNode.appendChild(lastElementChild);
        }
    }

    function modifyParentCategory(id) {
        let elem = document.getElementById('category'+id);
        let buttonElem = document.getElementById('modify'+id);

        if (buttonElem.innerText === '수정') {
            elem.readOnly = false;
            buttonElem.innerHTML = '확인';
        } else {
            elem.readOnly = true;
            buttonElem.innerHTML = '수정';
        }
    }


</script>
</body>
</html>